name: Build and Deploy

# Quando parte la pipeline
on:
  push:
    branches:
      - master  # Solo su push a main
    paths:
      - 'app/**'  # Solo se cambia qualcosa in app/

# Variabili globali
env:
  IMAGE_NAME: salvatorebarretta14/my-cats-app
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest  # Macchina virtuale GitHub
    
    steps:
      # 1. Checkout del codice
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Per fare commit dopo
      
      # 2. Setup Docker Buildx (build avanzato)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 3. Login su Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      # 4. Genera tag univoco (SHA commit breve)
      - name: Generate image tag
        id: tag
        run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      # 5. Build e push immagine Docker
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
      
      # 6. Aggiorna values.yaml con nuovo tag
      - name: Update Helm values
        run: |
          sed -i "s/tag: .*/tag: ${{ steps.tag.outputs.IMAGE_TAG }}/" helm-chart/values.yaml
          sed -i "s|repository: .*|repository: ${{ env.IMAGE_NAME }}|" helm-chart/values.yaml
      
      # 7. Commit e push modifiche values.yaml
      - name: Commit updated values
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add helm-chart/values.yaml
          git commit -m "Update image tag to ${{ steps.tag.outputs.IMAGE_TAG }}"
          git push
